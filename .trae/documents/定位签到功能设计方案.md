# 定位签到功能设计方案

## 1. 目标与约束

- 老师发起定位签到后，学生端才允许提交签到
- 老师可配置签到范围（中心点 + 半径）与有效时间（时长，从当前时间算起）
- 学生仅在范围内且处于有效时间内，签到成功
- 支持同一班级/课程的多次签到（历史可追溯），并避免重复签到

## 2. 角色与权限

- 教师（Users.role = 2）
  - 发起签到、查看进行中/历史签到、查看统计、手动结束签到
- 学生（Users.role = 1）
  - 查看当前可签到任务、提交签到、查看自己的签到结果
- 管理员（Users.role = 0，可选）
  - 运营/审计，查看全量数据（可后续扩展）

权限判定建议：

- 发起签到：教师且对目标“自己任课的课程 + 其覆盖的班级”有管理权限
- 查看统计：发起人/任课教师/班主任/管理员

## 3. 核心流程（业务视角）

### 3.1 教师发起签到

1) 教师先选择“自己任教的课程”（course），再从该课程关联的班级列表中勾选一个或多个班级
2) 教师在地图上选择签到中心点（lat/lng）并输入半径（米）与有效时长（分钟，从当前时间算起）
3) 服务端创建“签到场次（Session）”，关联课程 + 班级集合，状态置为进行中
4) 学生端在页面内自行刷新/轮询获取签到场次（先不做通知推送）

### 3.2 学生签到

1) 学生端获取“当前可签到场次”
2) 学生端上报当前位置（lat/lng、定位精度 accuracy、定位时间）
3) 服务端校验：时间有效 + 半径内 + 用户属于该班级/课程 + 未重复签到
4) 写入签到记录，返回成功/失败原因

### 3.3 教师查看结果与结束

- 实时统计：总人数、已签到、未签到
- 可手动结束签到：将 Session 状态置为已结束（提前终止）

## 4. 数据模型设计（建议）

> 当前项目已有表：`check_ins`（实体 [CheckIns](file:///Users/ccj/space/my-project/campus_chat/campus_chat_backend/campus_chat_platform/src/main/java/com/ccj/campus/chat/entity/CheckIns.java)），以及班级与成员关系：`classes`（[Classes](file:///Users/ccj/space/my-project/campus_chat/campus_chat_backend/campus_chat_platform/src/main/java/com/ccj/campus/chat/entity/Classes.java)）、`user_class`（[UserClassRel](file:///Users/ccj/space/my-project/campus_chat/campus_chat_backend/campus_chat_platform/src/main/java/com/ccj/campus/chat/entity/UserClassRel.java)）、`users`（[Users](file:///Users/ccj/space/my-project/campus_chat/campus_chat_backend/campus_chat_platform/src/main/java/com/ccj/campus/chat/entity/Users.java)）。

为了支持“一个老师多门课程、多班级”的场景，建议显式引入课程与授课关系：

### 4.1 新增：课程与授课关系

**4.1.1 课程表（courses）**

| 字段          | 类型     | 含义                     |
| ------------- | -------- | ------------------------ |
| id            | bigint   | 主键                     |
| name          | varchar(255)  | 课程名称，例如“高等数学” |
| code          | varchar(255)  | 课程编号（可选）         |
| department_id | bigint   | 开课学院                 |
| created_time  | timestamp(3) | 创建时间                 |
| updated_time  | timestamp(3) | 更新时间                 |

**4.1.2 任课关系表（teacher_course）**

一位老师可以任教多门课程，一门课程也可以由多位老师授课（如不同班级分流）。

| 字段         | 类型     | 含义                         |
| ------------ | -------- | ---------------------------- |
| id           | bigint   | 主键                         |
| teacher_uid  | bigint   | 老师 UID（users.id，role=2） |
| course_id    | bigint   | 课程 ID                      |
| created_time | timestamp(3) | 创建时间                     |

**4.1.3 课程-班级关系表（course_class）**

一门课程可以在多个班级开课，一个班级也可以关联多门课程。

| 字段         | 类型     | 含义                  |
| ------------ | -------- | --------------------- |
| id           | bigint   | 主键                  |
| course_id    | bigint   | 课程 ID               |
| class_id     | bigint   | 班级 ID（classes.id） |
| created_time | timestamp(3) | 创建时间              |

这样，教师的“可选课程 + 班级”集合可以通过以下链路获得：

`teacher_uid` → teacher_course → courses → course_class → classes

### 4.2 新增：签到场次表（check_in_session）

用于描述“老师发起的一次签到任务”，并承载范围/时间/状态等配置。

字段建议：

| 字段             | 类型     | 含义                                |
| ---------------- | -------- | ----------------------------------- |
| id               | bigint   | 主键                                |
| course_id        | bigint   | 课程 ID                             |
| teacher_uid      | bigint   | 发起人 UID                          |
| title            | varchar(255)  | 标题（例如“高数(1) 第3周周三签到”） |
| center_latitude  | decimal(10,7)  | 中心点纬度                          |
| center_longitude | decimal(10,7)  | 中心点经度                          |
| radius_meters    | int      | 半径（米）                          |
| duration_minutes | int      | 有效时长（分钟，从当前时间算起）    |
| start_time       | timestamp(3) | 开始时间（创建时=当前时间）         |
| end_time         | timestamp(3) | 结束时间（start_time+duration）     |
| status           | tinyint  | 0未开始/1进行中/2已结束/3已作废     |
| created_time     | timestamp(3) | 创建时间                            |
| updated_time     | timestamp(3) | 更新时间                            |

### 4.3 新增：签到场次-班级关系表（check_in_session_class）

用于表达“一次签到覆盖多个班级”。

| 字段         | 类型         | 含义 |
| ------------ | ------------ | ---- |
| id           | bigint       | 主键 |
| session_id   | bigint       | 签到场次 ID（check_in_session.id） |
| class_id     | bigint       | 班级 ID（classes.id） |
| created_time | timestamp(3) | 创建时间 |

约束与索引建议：
- unique(session_id, class_id)
- idx_class_id(class_id)

### 4.4 调整：签到记录表（check_ins）

当前 `check_ins` 需要补充“属于哪一次签到”的维度。

建议字段（在你现有的 `check_ins` 基础上补齐即可）：

| 字段          | 类型         | 含义 |
| ------------- | ------------ | ---- |
| id            | bigint       | 主键 |
| session_id    | bigint       | 签到场次 ID |
| user_id       | bigint       | 学生 UID |
| course_id     | bigint       | 课程 ID（可冗余，便于统计） |
| class_id      | bigint       | 班级 ID（可冗余，便于统计） |
| check_in_time | timestamp(3) | 签到时间 |
| location      | varchar(255) | 位置描述（可选） |
| latitude      | decimal(10,7) | 纬度 |
| longitude     | decimal(10,7) | 经度 |
| accuracy      | int          | 定位精度（可选，单位米） |
| status        | tinyint      | 1成功/2失败（或按你现有约定） |
| create_time   | timestamp(3) | 创建时间 |
| update_time   | timestamp(3) | 更新时间 |

约束与索引建议：
- unique(session_id, user_id) 防重复签到
- idx_session_id(session_id)
- idx_user_id(user_id)

## 5. 接口设计（REST）

### 5.1 教师端

- 获取自己任教的课程列表
  - `GET /courses/mine`
  - 返回：courseId、name

- 获取某门课的班级列表
  - `GET /courses/{courseId}/classes`
  - 返回：classId、name

- 创建签到场次（有效时间从当前时间算起）
  - `POST /checkin/sessions`
  - 入参：courseId、classIds[]、centerLat、centerLng、radiusMeters、durationMinutes、title
  - 出参：sessionId、startTime、endTime、status

- 结束签到场次
  - `POST /checkin/sessions/{sessionId}/end`

- 查看签到统计（只要三项）
  - `GET /checkin/sessions/{sessionId}/stats`
  - 返回：totalCount、checkedCount、uncheckedCount

### 5.2 学生端

- 获取当前可签到场次（不做通知，靠学生端拉取）
  - `GET /checkin/sessions/available`
  - 返回：与学生班级匹配、且处于有效时间内的 sessions（可多个）

- 提交签到
  - `POST /checkin/sessions/{sessionId}/check`
  - 入参：latitude、longitude、accuracy（可选）
  - 出参：成功/失败原因（超时/超范围/重复/无权限等）

## 6. 核心校验规则（服务端）

以“提交签到”接口为例，服务端按以下顺序校验，失败即返回明确错误码与提示：

1) 登录态校验：从 token 得到 uid
2) 场次存在且进行中：sessionId 有效，status=进行中
3) 时间有效：now ∈ [start_time, end_time]
4) 学生归属校验：
   - 通过 uid → classId（`user_class` 或 `users.classId`）确定学生班级
   - 班级必须在 session 覆盖的班级集合（check_in_session_class）中
5) 防重复：unique(session_id, user_id) 或插入冲突视为已签到
6) 半径校验：
   - 计算学生位置与中心点的球面距离（米）
   - 距离 ≤ radius_meters 才允许成功
7) 记录落库：写入 check_ins

## 7. 统计口径（仅三项）

目标：totalCount、checkedCount、uncheckedCount

- totalCount：本次 session 覆盖的全部班级的学生总数（distinct uid）
- checkedCount：check_ins 中 session_id = 当前 session 且 status=成功 的人数（distinct user_id）
- uncheckedCount：totalCount - checkedCount

## 8. 教师端“选择签到班级”多选交互

目标：创建签到场次时，教师可以对某一门课程勾选多个班级，最终提交 `classIds[]`。

### 8.1 交互流程

1) 教师进入“发起签到”页
2) 选择课程（下拉/列表）
3) 点击“选择班级”进入班级选择页（或弹窗）
4) 多选班级后确认返回发起页，显示已选班级摘要
5) 提交创建签到：`POST /checkin/sessions`，携带 `courseId + classIds[]`

### 8.2 多选控件形态（建议）

- 列表行：班级名称 + 复选框（checkbox）
- 顶部：搜索框（按班级名过滤，可选）
- 顶部：全选/全不选（可选）
- 底部：已选数量 + 确认按钮
- 发起页：展示已选班级（例如标签/逗号列表），并提供“重新选择”

### 8.3 校验规则

- 必选：`classIds` 至少 1 个
- 限制：`classIds` 必须属于该 `courseId` 的班级集合（后端二次校验）
- 防重复：前端去重；后端依赖 `unique(session_id, class_id)` 防止重复写关联表

### 8.4 后端落库行为（与多选对应）

创建 session 成功后：

- 先插入 `check_in_session`
- 再批量插入 `check_in_session_class`（每个 classId 一条）
